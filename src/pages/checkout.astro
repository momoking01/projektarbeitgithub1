---
import Layout from "../components/layout.astro";
---

<Layout>
  <div class="checkout-container">
    <h1>Checkout</h1>
    <p><strong>Total Items:</strong> <span id="total-items">0</span></p>

    <h2>Order Summary</h2>
    <ul id="order-summary"></ul>

    <h2>Payment Method</h2>
    <select id="payment-method">
      <option value="cash">Cash</option>
      <option value="sepa">SEPA Direct Debit</option>
    </select>

    <button onclick="placeOrder()">Place Order</button>
  </div>
</Layout>

<script is:inline>
  function loadCartSummary() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let totalItems = document.getElementById("total-items");
    let orderSummary = document.getElementById("order-summary");

    let totalCount = 0;
    orderSummary.innerHTML = "";

    cart.forEach(item => {
      totalCount += item.quantity;
      let li = document.createElement("li");
      li.textContent = `${item.name} (x${item.quantity})`;
      orderSummary.appendChild(li);
    });

    totalItems.textContent = totalCount;
  }

  async function placeOrder() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    if (cart.length === 0) {
      alert("Your cart is empty.");
      return;
    }

    let paymentMethod = document.getElementById("payment-method").value;

    let newOrder = {
      date: new Date().toISOString(),
      items: cart,
      payment: paymentMethod
    };

    try {
      const response = await fetch("http://localhost:5000/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newOrder)
      });

      if (!response.ok) {
        throw new Error("Failed to place order.");
      }

      localStorage.removeItem("cart");
      alert("Order placed successfully!");
      window.location.href = "/projektarbeitgithub1/orders";
    } catch (error) {
      console.error("Error:", error);
      alert("Something went wrong. Try again later.");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("place-order-btn").addEventListener("click", placeOrder);
  });

  window.onload = loadCartSummary;
</script>

<style>
  .checkout-container {
    text-align: center;
    padding: 20px;
  }

  select, button {
    margin: 10px;
    padding: 5px;
  }
</style>